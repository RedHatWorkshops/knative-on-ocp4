# Build using OpenShift Pipeline


## Pre-requisites
* OCP4 cluster with Knative-serving, Tekton installed
* You need to be logged in as admin credentials
* `git clone` this repository. We have some samples here.

## Steps

* Login as an `admin` user to your cluster

* Create a new project for your application `oc new-project kn-demo`

* Create a service account for your pipeline

```
oc create serviceaccount pipeline
oc adm policy add-scc-to-user privileged -z pipeline
oc adm policy add-role-to-user edit -z pipeline
```

We will use Openshift S2I to run the build.

Let us install tekton tasks for `s2i-go` and  `openshift-client`.

* `s2i-go` task is used to build an application written in golang
* `openshift-client` allows us to run `oc` commands as part of the pipeline

**Note:** List of S2I build tasks available for different languages can be found here:
[https://github.com/openshift/pipelines-catalog](https://github.com/openshift/pipelines-catalog)

```
oc create -f https://raw.githubusercontent.com/openshift/pipelines-catalog/master/s2i-go/s2i-go-task.yaml

oc create -f https://raw.githubusercontent.com/tektoncd/catalog/master/openshift-client/openshift-client-task.yaml

```


Now we will create the application objects `imagestream`, `deploymentconfig`, `service` and `route`. These objects are made available the pipeline folder.

```
$ oc create -f pipeline/openshift-objects.yaml 
imagestream.image.openshift.io/dumpy created
deploymentconfig.apps.openshift.io/dumpy created
service/dumpy created
route.route.openshift.io/dumpy created
```


Let us look at the pipeline that shows the list of tasks within the pipeline to create the application image using `s2i-go` task and deploy it using `openshift-client` task. Note that this pipeline depends on source code coming from `app-git` and pushes image to `app-image` resource.

```
$ cat pipeline/pipeline.yaml
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: deploy-pipeline
spec:
  resources:
  - name: app-git
    type: git
  - name: app-image
    type: image
  tasks:
  - name: build
    taskRef:
      name: s2i-go
    params:
      - name: TLSVERIFY
        value: "false"
    resources:
      inputs:
      - name: source
        resource: app-git
      outputs:
      - name: image
        resource: app-image
  - name: deploy
    taskRef:
      name: openshift-client
    runAfter:
      - build
    params:
    - name: ARGS
      value: "rollout latest dumpy"
```

Let us create the pipeline by running

```
$ oc create -f pipeline/pipeline.yaml 

pipeline.tekton.dev/deploy-pipeline created
```


The resources used by this pipeline are defined in the `pipeline-resources` file as shown below:

```
$ cat pipeline/pipeline-resources.yaml 
---
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: application-image
spec:
  type: image
  params:
  - name: url
    value: image-registry.openshift-image-registry.svc:5000/kn-demo/dumpy
---
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: sourcecode-git
spec:
  type: git
  params:
  - name: url
    value: https://github.com/redhatworkshops/openshift-knative-application

```

Now let us add these pipeline-resources running:

```
$ oc create -f pipeline/pipeline-resources.yaml 

pipelineresource.tekton.dev/application-image created
pipelineresource.tekton.dev/sourcecode-git created
```


